{% extends "base.html" %}

{% block content %}
<section class="rounded-2xl border border-gray-100 bg-white p-8 shadow-sm">
  <div class="flex flex-col gap-0">
    <div class="flex items-center justify-between">
      <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Article</p>
      <div class="flex flex-wrap gap-3">
        <a class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium transition hover:border-blue-200 hover:text-blue-600" href="#comments">Add comment</a>
        <form method="post" action="/articles/{{ article.id }}/delete" onsubmit="return confirm('Delete this article?');">
          <button class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-slate-800" type="submit">Delete</button>
        </form>
      </div>
    </div>
    <div>
      <h1 class="mt-3 text-3xl font-bold tracking-tight text-slate-900 md:text-4xl">{{ article.title }}</h1>
      <div class="mt-4 text-sm leading-relaxed text-slate-600 [&_p]:mb-3 [&_ul]:ml-5 [&_ul]:list-disc [&_ol]:ml-5 [&_ol]:list-decimal [&_strong]:text-slate-900">
        {{ article.summary | markdown }}
      </div>
      <div class="mt-6 flex flex-wrap items-center gap-3 text-xs text-slate-500">
        {% set categories = article.metadata_.get('categories') or [article.metadata_.get('category', 'uncategorized')] %}
        {% for category in categories %}
          <span class="rounded-full bg-blue-50 px-3 py-1 text-blue-600">{{ category.replace('_', ' ').title() }}</span>
        {% endfor %}
        <a class="text-slate-500 hover:text-slate-700" href="/articles{% if folder_id or scope == 'group' %}?{% endif %}{% if folder_id %}folder_id={{ folder_id }}{% endif %}{% if scope == 'group' and selected_group %}{% if folder_id %}&{% endif %}scope=group&group_id={{ selected_group.id }}{% endif %}">
          Folder: {{ folder_path }}
        </a>
        <span>Created {{ article.created_at | format_dt }}</span>
      </div>
    </div>
  </div>
</section>

<dialog id="source-modal" class="w-[90vw] max-w-4xl rounded-2xl border border-gray-200 bg-white p-0 shadow-xl">
  <div class="flex items-center justify-between border-b border-gray-100 px-4 py-3">
    <h3 class="text-sm font-semibold text-slate-700">Attachment preview</h3>
    <button class="text-xs text-slate-500 hover:text-slate-700" type="button" id="source-modal-close">Close</button>
  </div>
  <iframe id="source-modal-frame" class="h-[70vh] w-full" src=""></iframe>
</dialog>

<section class="mt-8">
  <div class="rounded-2xl border border-gray-100 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap gap-2 text-sm">
      <button class="tab-button rounded-lg border border-blue-100 bg-blue-50 px-4 py-2 font-medium text-blue-600 transition" data-tab="classification" type="button">Classification</button>
      <button class="tab-button rounded-lg border border-gray-200 px-4 py-2 font-medium text-slate-600 transition hover:border-blue-100 hover:text-blue-600" data-tab="insights" type="button">Insights</button>
      <button class="tab-button rounded-lg border border-gray-200 px-4 py-2 font-medium text-slate-600 transition hover:border-blue-100 hover:text-blue-600" data-tab="effective" type="button">Effective view</button>
      <button class="tab-button rounded-lg border border-gray-200 px-4 py-2 font-medium text-slate-600 transition hover:border-blue-100 hover:text-blue-600" data-tab="comments" type="button">Comments</button>
      <button class="tab-button rounded-lg border border-gray-200 px-4 py-2 font-medium text-slate-600 transition hover:border-blue-100 hover:text-blue-600" data-tab="metadata" type="button">Metadata</button>
      <button class="tab-button rounded-lg border border-gray-200 px-4 py-2 font-medium text-slate-600 transition hover:border-blue-100 hover:text-blue-600" data-tab="content" type="button">Original content</button>
      <button class="tab-button rounded-lg border border-gray-200 px-4 py-2 font-medium text-slate-600 transition hover:border-blue-100 hover:text-blue-600" data-tab="files" type="button">Files</button>
    </div>

    <div class="mt-6">
      <div class="tab-panel" data-tab-panel="classification">
        <h3 class="text-sm font-semibold text-slate-600">Classification</h3>
        <div class="mt-4 flex flex-wrap gap-2">
          {% set categories = article.metadata_.get('categories') or [article.metadata_.get('category', 'uncategorized')] %}
          {% for category in categories %}
            <span class="rounded-full bg-blue-50 px-4 py-2 text-sm text-blue-600">{{ category.replace('_', ' ').title() }}</span>
          {% endfor %}
        </div>
      </div>
      <div class="tab-panel hidden" data-tab-panel="insights">
        <h3 class="text-sm font-semibold text-slate-600">Insights</h3>
        {% set insights = article.metadata_.get("insights", {}) %}
        {% if insights %}
          <div class="mt-4 grid gap-4 md:grid-cols-2">
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
              <p class="text-xs uppercase tracking-wide text-slate-500">Key points</p>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                {% for item in insights.get("key_points", []) %}
                  <li>{{ item }}</li>
                {% else %}
                  <li class="text-slate-400">No key points extracted.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
              <p class="text-xs uppercase tracking-wide text-slate-500">Action items</p>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                {% for item in insights.get("action_items", []) %}
                  <li>{{ item }}</li>
                {% else %}
                  <li class="text-slate-400">No action items extracted.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
              <p class="text-xs uppercase tracking-wide text-slate-500">Decisions</p>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                {% for item in insights.get("decisions", []) %}
                  <li>{{ item }}</li>
                {% else %}
                  <li class="text-slate-400">No decisions extracted.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
              <p class="text-xs uppercase tracking-wide text-slate-500">Risks</p>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                {% for item in insights.get("risks", []) %}
                  <li>{{ item }}</li>
                {% else %}
                  <li class="text-slate-400">No risks extracted.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
              <p class="text-xs uppercase tracking-wide text-slate-500">Metrics</p>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                {% for item in insights.get("metrics", []) %}
                  <li>{{ item }}</li>
                {% else %}
                  <li class="text-slate-400">No metrics extracted.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
              <p class="text-xs uppercase tracking-wide text-slate-500">Stakeholders & deadlines</p>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                {% for item in insights.get("stakeholders", []) %}
                  <li>{{ item }}</li>
                {% endfor %}
                {% for item in insights.get("deadlines", []) %}
                  <li>{{ item }}</li>
                {% endfor %}
                {% if not insights.get("stakeholders") and not insights.get("deadlines") %}
                  <li class="text-slate-400">No stakeholders or deadlines extracted.</li>
                {% endif %}
              </ul>
            </div>
          </div>
        {% else %}
          <p class="mt-4 text-sm text-slate-500">Insights will appear once this article is re-processed.</p>
        {% endif %}
      </div>
      <div class="tab-panel hidden" data-tab-panel="metadata">
        <h3 class="text-sm font-semibold text-slate-600">Metadata</h3>
        <pre class="mt-4 max-h-96 overflow-auto rounded-lg bg-gray-50 p-4 text-xs text-slate-700">{{ article.metadata_ | tojson(indent=2) }}</pre>
      </div>
      <div class="tab-panel hidden" data-tab-panel="effective">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-slate-600">Effective content (after comments)</h3>
          {% if has_effective_override %}
            <span class="rounded-full border border-amber-100 bg-amber-50 px-3 py-1 text-xs text-amber-700">Adjusted by comments</span>
          {% endif %}
        </div>
        <div class="mt-4 rounded-lg border border-gray-100 bg-gray-50 p-4">
          <p class="text-xs uppercase tracking-wide text-slate-500">Summary</p>
          <div class="mt-2 text-sm text-slate-700 leading-relaxed [&_p]:mb-3 [&_ul]:ml-5 [&_ul]:list-disc [&_ol]:ml-5 [&_ol]:list-decimal [&_strong]:text-slate-900">
            {{ effective_summary | markdown }}
          </div>
        </div>
        <div class="mt-4 max-h-[32rem] overflow-auto rounded-lg bg-gray-50 p-4 text-sm text-slate-700 leading-relaxed [&_p]:mb-3 [&_ul]:ml-5 [&_ul]:list-disc [&_ol]:ml-5 [&_ol]:list-decimal [&_strong]:text-slate-900">
          {{ effective_content | markdown }}
        </div>
      </div>
      <div class="tab-panel hidden" data-tab-panel="comments" id="comments">
        <h3 class="text-sm font-semibold text-slate-600">Add comment or override</h3>
        <form class="mt-4 space-y-4 rounded-lg border border-gray-100 bg-gray-50 p-4" method="post" action="/articles/{{ article.id }}/comments">
          <label class="block text-sm font-medium text-slate-600">
            Mode
            <select name="mode" class="mt-2 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600/20">
              <option value="augment">Augment original content</option>
              <option value="supersede">Supersede summary/content</option>
            </select>
          </label>
          <label class="block text-sm font-medium text-slate-600">
            Comment / rationale
            <textarea name="comment_text" rows="4" class="mt-2 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600/20" placeholder="Example: Treat pricing section as outdated as of Jan 2026."></textarea>
          </label>
          <label class="block text-sm font-medium text-slate-600">
            Replacement summary (optional)
            <textarea name="replacement_summary" rows="3" class="mt-2 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600/20" placeholder="Only used when mode is supersede."></textarea>
          </label>
          <label class="block text-sm font-medium text-slate-600">
            Replacement content (optional)
            <textarea name="replacement_content" rows="8" class="mt-2 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600/20" placeholder="Only used when mode is supersede."></textarea>
          </label>
          <div class="flex justify-end">
            <button type="submit" class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-slate-800">Save comment</button>
          </div>
        </form>

        <h4 class="mt-6 text-sm font-semibold text-slate-600">History</h4>
        {% if comments %}
          <div class="mt-3 space-y-3">
            {% for item in comments | reverse %}
              <article class="rounded-lg border border-gray-100 bg-white p-4">
                <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                  <span class="rounded-full border px-2 py-1 {% if item.mode == 'supersede' %}border-amber-200 bg-amber-50 text-amber-700{% else %}border-blue-200 bg-blue-50 text-blue-700{% endif %}">
                    {{ item.mode }}
                  </span>
                  <span>{{ item.author_email }}</span>
                  <span>{{ item.created_at | format_dt }}</span>
                </div>
                {% if item.comment_text %}
                  <div class="mt-3 text-sm text-slate-700 leading-relaxed">{{ item.comment_text | markdown }}</div>
                {% endif %}
                {% if item.replacement_summary %}
                  <div class="mt-3 rounded-lg bg-gray-50 p-3 text-sm text-slate-700">
                    <p class="text-xs uppercase tracking-wide text-slate-500">Replacement summary</p>
                    <div class="mt-1">{{ item.replacement_summary | markdown }}</div>
                  </div>
                {% endif %}
                {% if item.replacement_content %}
                  <div class="mt-3 rounded-lg bg-gray-50 p-3 text-sm text-slate-700">
                    <p class="text-xs uppercase tracking-wide text-slate-500">Replacement content</p>
                    <div class="mt-1">{{ item.replacement_content | markdown }}</div>
                  </div>
                {% endif %}
              </article>
            {% endfor %}
          </div>
        {% else %}
          <p class="mt-3 text-sm text-slate-500">No comments yet.</p>
        {% endif %}
      </div>
      <div class="tab-panel hidden" data-tab-panel="content">
        <h3 class="text-sm font-semibold text-slate-600">Original content</h3>
        <div class="mt-4 max-h-[32rem] overflow-auto rounded-lg bg-gray-50 p-4 text-sm text-slate-700 leading-relaxed [&_p]:mb-3 [&_ul]:ml-5 [&_ul]:list-disc [&_ol]:ml-5 [&_ol]:list-decimal [&_strong]:text-slate-900">
          {{ article.content_text | markdown }}
        </div>
      </div>
      <div class="tab-panel hidden" data-tab-panel="files">
        <h3 class="text-sm font-semibold text-slate-600">Files</h3>
        {% if sources %}
          <div class="mt-4 space-y-3 text-sm text-slate-600">
            {% for source in sources %}
              <div class="flex flex-wrap items-center gap-3 rounded-lg border border-gray-100 bg-gray-50 px-4 py-3">
                <button class="rounded-full border border-slate-200 px-3 py-1 text-xs transition hover:border-blue-200 hover:text-blue-600" type="button" data-preview-src="/articles/{{ article.id }}/sources/{{ source.id }}?inline=1">
                  {{ source.name }}
                </button>
                <a class="text-xs text-slate-400 hover:text-slate-600" target="_blank" href="/articles/{{ article.id }}/sources/{{ source.id }}?inline=1">Open</a>
                <a class="text-xs text-slate-400 hover:text-slate-600" href="/articles/{{ article.id }}/sources/{{ source.id }}">Download</a>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="mt-4 text-sm text-slate-500">No original files attached.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabPanels = document.querySelectorAll('.tab-panel');
  const modal = document.getElementById('source-modal');
  const modalFrame = document.getElementById('source-modal-frame');
  const modalClose = document.getElementById('source-modal-close');
  const previewButtons = document.querySelectorAll('[data-preview-src]');

  function setActiveTab(tabName) {
    tabButtons.forEach(button => {
      const isActive = button.dataset.tab === tabName;
      button.classList.toggle('bg-blue-50', isActive);
      button.classList.toggle('border-blue-100', isActive);
      button.classList.toggle('text-blue-600', isActive);
      button.classList.toggle('border-gray-200', !isActive);
      button.classList.toggle('text-slate-600', !isActive);
    });
    tabPanels.forEach(panel => {
      panel.classList.toggle('hidden', panel.dataset.tabPanel !== tabName);
    });
  }

  function tabFromHash() {
    const hash = window.location.hash.replace('#', '').trim();
    if (hash === 'comments') {
      setActiveTab('comments');
      return;
    }
    if (hash === 'effective') {
      setActiveTab('effective');
      return;
    }
  }

  tabButtons.forEach(button => {
    button.addEventListener('click', () => setActiveTab(button.dataset.tab));
  });

  tabFromHash();
  window.addEventListener('hashchange', tabFromHash);

  previewButtons.forEach(button => {
    button.addEventListener('click', () => {
      modalFrame.src = button.dataset.previewSrc;
      modal.showModal();
    });
  });

  modalClose.addEventListener('click', () => {
    modal.close();
    modalFrame.src = '';
  });
</script>
{% endblock %}
