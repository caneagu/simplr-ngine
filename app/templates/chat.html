{% extends "base.html" %}

{% block content %}
<div class="grid gap-6 lg:grid-cols-[1.6fr_0.8fr]">
  <section class="rounded-2xl border border-gray-100 bg-white p-8 shadow-sm">
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Knowledge Chat</p>
        <h1 class="mt-2 text-3xl font-bold tracking-tight text-slate-900">Ask your RAG assistant</h1>
        <p class="mt-2 text-sm text-slate-500">Get grounded answers, plus a live list of cited articles.</p>
      </div>
      <div class="rounded-lg border border-gray-100 bg-gray-50 px-4 py-3 text-xs text-slate-500">
        Streaming mode enabled
      </div>
    </header>

    <div class="mt-6 h-[28rem] overflow-y-auto rounded-2xl border border-gray-200 bg-gray-50 p-6" id="chat-thread">
      <div class="flex">
        <div class="rounded-lg border border-gray-200 bg-white px-4 py-3 text-sm text-slate-600 shadow-sm">
          <p>Hi! Ask me anything about your knowledge base.</p>
        </div>
      </div>
    </div>

    <form class="mt-6 space-y-4" id="chat-form">
      <textarea
        class="w-full resize-none rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm shadow-sm focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600/20"
        id="chat-input"
        name="question"
        rows="3"
        placeholder="Ask a question..."
      ></textarea>
      <div class="flex items-center justify-between">
        <p class="text-xs text-slate-500">Shift + Enter for a new line</p>
        <button class="rounded-lg bg-slate-900 px-6 py-3 text-sm font-medium text-white shadow-lg shadow-slate-900/10 transition hover:bg-slate-800" type="submit">Ask</button>
      </div>
    </form>

    <p class="mt-4 hidden rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700" id="chat-error"></p>
  </section>

  <aside class="rounded-2xl border border-gray-100 bg-white p-6 shadow-sm">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">References</h2>
      <span class="rounded-full bg-blue-50 px-3 py-1 text-xs text-blue-600">Live</span>
    </div>
    <ul class="mt-6 space-y-3 text-sm text-slate-600" id="chat-refs">
      <li class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-3 text-slate-400">No references yet.</li>
    </ul>
  </aside>
</div>

<script>
  const form = document.getElementById('chat-form');
  const input = document.getElementById('chat-input');
  const thread = document.getElementById('chat-thread');
  const refsList = document.getElementById('chat-refs');
  const errorBox = document.getElementById('chat-error');

  function addBubble(text, role) {
    const bubble = document.createElement('div');
    bubble.className = `max-w-[75%] rounded-lg px-4 py-3 text-sm leading-relaxed shadow-sm ${
      role === 'user'
        ? 'ml-auto bg-slate-900 text-white'
        : 'border border-gray-200 bg-white text-slate-700'
    }`;
    const p = document.createElement('p');
    p.textContent = text;
    bubble.appendChild(p);
    const wrapper = document.createElement('div');
    wrapper.className = 'mt-4 flex';
    if (role === 'user') {
      wrapper.classList.add('justify-end');
    }
    wrapper.appendChild(bubble);
    thread.appendChild(wrapper);
    thread.scrollTop = thread.scrollHeight;
    return bubble;
  }

  function setError(message) {
    if (!message) {
      errorBox.classList.add('hidden');
      errorBox.textContent = '';
      return;
    }
    errorBox.classList.remove('hidden');
    errorBox.textContent = message;
  }

  function updateRefs(refs) {
    refsList.innerHTML = '';
    if (!refs || refs.length === 0) {
      const li = document.createElement('li');
      li.className = 'rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-3 text-slate-400';
      li.textContent = 'No references yet.';
      refsList.appendChild(li);
      return;
    }
    refs.forEach(ref => {
      const li = document.createElement('li');
      const link = document.createElement('a');
      link.className = 'block rounded-lg border border-gray-200 bg-white px-4 py-3 transition hover:border-blue-100 hover:text-blue-600';
      link.href = `/articles/${ref.id}`;
      link.textContent = ref.title;
      li.appendChild(link);
      refsList.appendChild(li);
    });
  }

  async function streamAnswer(question) {
    setError('');
    const userBubble = addBubble(question, 'user');
    const answerBubble = addBubble('', 'assistant');

    const response = await fetch('/chat/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question })
    });

    if (!response.ok) {
      const errorText = await response.text();
      setError(errorText);
      answerBubble.remove();
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let buffer = '';
    let answerText = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const parts = buffer.split('\\n\\n');
      buffer = parts.pop();
      for (const part of parts) {
        const lines = part.split('\\n');
        let event = 'message';
        let data = '';
        for (const line of lines) {
          if (line.startsWith('event: ')) {
            event = line.slice(7).trim();
          } else if (line.startsWith('data: ')) {
            data += line.slice(6);
          }
        }

        if (event === 'refs') {
          try {
            updateRefs(JSON.parse(data));
          } catch {}
        } else if (event === 'answer') {
          try {
            const token = JSON.parse(data);
            answerText += token;
            answerBubble.querySelector('p').textContent = answerText;
          } catch {}
        } else if (event === 'done') {
          return;
        }
      }
    }
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const question = input.value.trim();
    if (!question) return;
    input.value = '';
    await streamAnswer(question);
  });
</script>
{% endblock %}
